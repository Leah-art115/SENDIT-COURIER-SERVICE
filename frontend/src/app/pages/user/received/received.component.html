<app-user-navbar></app-user-navbar>

<div class="filter-bar">
  <input type="text" [(ngModel)]="filterName" placeholder="Search by sender" />
  <input type="date" [(ngModel)]="filterDateFrom" />
  <input type="date" [(ngModel)]="filterDateTo" />

  <select [(ngModel)]="filterStatus">
    <option value="">All Statuses</option>
    <option value="PENDING">Pending</option>
    <option value="ASSIGNED">Assigned</option>
    <option value="PICKED_UP_BY_DRIVER">Picked Up</option>
    <option value="IN_TRANSIT">In Transit</option>
    <option value="DELIVERED">Delivered</option>
    <option value="COLLECTED_BY_RECEIVER">Collected</option>
    <option value="CANCELLED">Cancelled</option>
  </select>

  <select [(ngModel)]="filterMode">
    <option value="">All Modes</option>
    <option value="STANDARD">Standard</option>
    <option value="EXPRESS">Express</option>
  </select>

  <select [(ngModel)]="filterType">
    <option value="">All Types</option>
    <option value="BOXED_PACKAGE">Box</option>
    <option value="ENVELOPE">Envelope</option>
    <option value="BAG">Bag</option>
    <option value="SUITCASE">Suitcase</option>
  </select>
</div>

<div class="parcel-cards">
  <div class="card" *ngFor="let p of filteredParcels">
    <h3>{{ p.trackingId }}</h3>
    <p><strong>From:</strong> {{ p.sender }}</p>
    <p><strong>From:</strong> {{ p.from }} → <strong>To:</strong> {{ p.to }}</p>
    <p><strong>Date Sent:</strong> {{ p.dateSent }}</p>
    <p><strong>Status:</strong> {{ p.status }}</p>
    <p><strong>Price:</strong> {{ p.price }}</p>
    <button (click)="openMap(p)">Track</button>
    <button (click)="openInfo(p)">View More Info</button>
    <button *ngIf="p.status === 'DELIVERED'" (click)="markAsComplete(p)">
      Mark as Received
    </button>
  </div>
</div>

<!-- MAP MODAL -->
<div class="modal-overlay" [class.show]="showMapModal" (click)="closeModals()">
  <div class="tracking-modal" (click)="$event.stopPropagation()" *ngIf="selectedParcel">
    <div class="modal-header">
      <h2>Package Tracking</h2>
      <button class="close-btn" (click)="closeModals()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-content">
      <div class="package-info">
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Tracking ID:</span>
            <span class="value">{{ selectedParcel.trackingId }}</span>
          </div>
          <div class="info-item">
            <span class="label">Status:</span>
            <span class="value status" [style.color]="getStatusColor(selectedParcel.status)">
              {{ formatStatus(selectedParcel.status) }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">From:</span>
            <span class="value">{{ selectedParcel.from }}</span>
          </div>
          <div class="info-item">
            <span class="label">To:</span>
            <span class="value">{{ selectedParcel.to }}</span>
          </div>
          <div class="info-item">
            <span class="label">Sender:</span>
            <span class="value">{{ selectedParcel.sender }}</span>
          </div>
          <div class="info-item">
            <span class="label">Expected Delivery:</span>
            <span class="value">{{ selectedParcel.expectedDelivery | date:'MMM dd, yyyy' }}</span>
          </div>
        </div>
      </div>

      <div class="map-section">
        <h3>Route & Current Location</h3>
        <div id="google-map" class="tracking-map"></div>
        <div class="map-legend">
          <div class="legend-item">
            <span class="legend-color origin"></span>
            <span>Origin</span>
          </div>
          <div class="legend-item">
            <span class="legend-color current"></span>
            <span>Current Location</span>
          </div>
          <div class="legend-item">
            <span class="legend-color destination"></span>
            <span>Destination</span>
          </div>
        </div>
      </div>

      <div class="timeline-section">
        <h3>Delivery Timeline</h3>
        <div class="timeline">
          <div class="timeline-item" 
               *ngFor="let item of createTimeline(selectedParcel)" 
               [class.completed]="item.completed">
            <div class="timeline-dot" [style.background-color]="item.completed ? '#22c55e' : '#e5e7eb'"></div>
            <div class="timeline-content">
              <div class="timeline-status">{{ item.status }}</div>
              <div class="timeline-details">
                <span class="timeline-date">{{ item.date }}</span>
                <span class="timeline-location">{{ item.location }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="package-details">
        <h3>Package Details</h3>
        <div class="details-grid">
          <div class="detail-item">
            <span class="label">Description:</span>
            <span class="value">{{ selectedParcel.description || 'No description available' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Weight:</span>
            <span class="value">{{ selectedParcel.weight }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Type:</span>
            <span class="value">{{ selectedParcel.type }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Delivery Mode:</span>
            <span class="value">{{ selectedParcel.deliveryMode }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Payment Method:</span>
            <span class="value">{{ selectedParcel.paymentMethod }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Date Sent:</span>
            <span class="value">{{ selectedParcel.dateSent | date:'MMM dd, yyyy' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Price:</span>
            <span class="value">{{ selectedParcel.price }}</span>
          </div>
        </div>
      </div>

      <button *ngIf="selectedParcel.status === 'DELIVERED'" (click)="markAsComplete(selectedParcel)">
        Mark as Received
      </button>
    </div>
  </div>
</div>

<!-- INFO MODAL -->
<div class="modal" *ngIf="showInfoModal">
  <div class="modal-content">
    <h3>Parcel Details - {{ selectedParcel?.trackingId }}</h3>
    <p><strong>Sender:</strong> {{ selectedParcel?.sender }}</p>
    <p><strong>From:</strong> {{ selectedParcel?.from }} → <strong>To:</strong> {{ selectedParcel?.to }}</p>
    <p><strong>Status:</strong> {{ selectedParcel?.status }}</p>
    <p><strong>Description:</strong> {{ selectedParcel?.description }}</p>
    <p><strong>Type:</strong> {{ selectedParcel?.type }}</p>
    <p><strong>Weight:</strong> {{ selectedParcel?.weight }}</p>
    <p><strong>Payment Method:</strong> {{ selectedParcel?.paymentMethod }}</p>
    <p><strong>Delivery Mode:</strong> {{ selectedParcel?.deliveryMode }}</p>
    <p><strong>Expected Delivery:</strong> {{ selectedParcel?.expectedDelivery }}</p>
    <p><strong>Price:</strong> {{ selectedParcel?.price }}</p>
    <button *ngIf="selectedParcel?.status === 'DELIVERED'" (click)="markAsComplete(selectedParcel!)">
      Mark as Received
    </button>
    <button (click)="closeModals()">Close</button>
  </div>
</div>